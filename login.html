<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - EPA 703</title>
    <meta name="description" content="Sistema de acceso para estudiantes, profesores y administradores de EPA 703">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <!-- Mensaje de logout exitoso -->
    <div id="logout-message" class="logout-message">
        ‚úÖ Sesi√≥n cerrada exitosamente
    </div>

    <div class="login-container">
        <!-- Header con logo -->
        <div class="login-header">
            <div class="logo">
                EPA
            </div>
            <h1 class="login-title">EPA 703</h1>
            <p class="login-subtitle">Sistema de Gesti√≥n Acad√©mica</p>
        </div>

        <!-- Formulario de login -->
        <form id="loginForm">
            <!-- Selector de rol -->
            <div class="role-grid">
                <div class="role-card">
                    <input type="radio" id="estudiante" name="role" value="estudiante" checked>
                    <label for="estudiante" class="role-label">
                        <div class="role-icon">üéì</div>
                        <div class="role-text">Estudiante</div>
                    </label>
                </div>
                <div class="role-card">
                    <input type="radio" id="profesor" name="role" value="profesor">
                    <label for="profesor" class="role-label">
                        <div class="role-icon">üë®‚Äçüè´</div>
                        <div class="role-text">Profesor</div>
                    </label>
                </div>
                <div class="role-card">
                    <input type="radio" id="admin" name="role" value="admin">
                    <label for="admin" class="role-label">
                        <div class="role-icon">‚öôÔ∏è</div>
                        <div class="role-text">Admin</div>
                    </label>
                </div>
            </div>

            <!-- Campo de usuario -->
            <div class="form-group">
                <label for="usuario" class="form-label">Correo Electr√≥nico</label>
                <input type="email" 
                       id="usuario" 
                       name="usuario" 
                       class="form-input" 
                       required 
                       autocomplete="username" 
                       placeholder="usuario@epa703.edu.ar">
            </div>

            <!-- Campo de contrase√±a -->
            <div class="form-group">
                <label for="password" class="form-label">Contrase√±a</label>
                <div class="password-group">
                    <input type="password" 
                           id="password" 
                           name="password" 
                           class="form-input" 
                           required 
                           autocomplete="current-password" 
                           placeholder="Tu contrase√±a">
                    <button type="button" class="toggle-password" onclick="togglePassword()" aria-label="Mostrar/ocultar contrase√±a">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>

            <!-- Bot√≥n de submit -->
            <button type="submit" class="login-button" id="loginButton">
                <span class="button-text">Iniciar Sesi√≥n</span>
                <div class="button-loading">
                    <div class="spinner"></div>
                </div>
            </button>
        </form>

        <!-- Link para volver -->
        <div class="back-link">
            <a href="index.html">‚Üê Volver al inicio</a>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Variables globales
        let isLoading = false;

        // Verificar mensaje de logout al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('logout') === 'success') {
                document.getElementById('logout-message').style.display = 'block';
                
                // Ocultar mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    document.getElementById('logout-message').style.display = 'none';
                }, 5000);
            }
        });

        // Manejar env√≠o del formulario
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            const formData = new FormData(this);
            const selectedRole = document.querySelector('input[name="role"]:checked').value;
            
            const loginData = {
                usuario: formData.get('usuario'),
                password: formData.get('password'),
                role: selectedRole
            };

            await handleLogin(loginData);
        });

        // ‚úÖ FUNCI√ìN CORREGIDA - Recibe datos del login, no evento
        async function handleLogin(loginData) {
            if (isLoading) return;
            
            isLoading = true;
            setLoading(true);
            
            try {
                const formData = new FormData();
                formData.append('usuario', loginData.usuario);
                formData.append('password', loginData.password);
                formData.append('role', loginData.role);
                
                const response = await fetch('api/ajax_login.php', {
                    method: 'POST',
                    body: formData
                });
                
                // Get response text first
                const responseText = await response.text();
                
                try {
                    // Try to parse as JSON
                    const data = JSON.parse(responseText);
                    
                    if (data.success) {
                        // Login successful
                        console.log('Login exitoso');
                        showAlert('¬°Bienvenido! Redirigiendo...', 'success');
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500);
                    } else {
                        // Login failed
                        showError(data.message || 'Error de autenticaci√≥n');
                    }
                } catch (parseError) {
                    // Response is not JSON - likely an HTML error page
                    console.error('Error parsing JSON:', parseError);
                    console.log('Response received:', responseText);
                    
                    // Check if response contains HTML error indicators
                    if (responseText.includes('<br />') || responseText.includes('<b>')) {
                        showError('Error del servidor. Por favor, contacte al administrador.');
                    } else {
                        showError('Error de comunicaci√≥n con el servidor.');
                    }
                }
                
            } catch (networkError) {
                console.error('Network error:', networkError);
                showError('Error de conexi√≥n. Verifique su conexi√≥n a internet.');
            } finally {
                isLoading = false;
                setLoading(false);
            }
        }

        // Funci√≥n para manejar el estado de carga del bot√≥n
        function setLoading(loading) {
            const button = document.getElementById('loginButton');
            const buttonText = button.querySelector('.button-text');
            const buttonLoading = button.querySelector('.button-loading');
            
            if (loading) {
                button.disabled = true;
                buttonText.style.opacity = '0';
                buttonLoading.style.display = 'block';
            } else {
                button.disabled = false;
                buttonText.style.opacity = '1';
                buttonLoading.style.display = 'none';
            }
        }

        // Funci√≥n para mostrar errores
        function showError(message) {
            // Remove any existing error messages
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Create and show error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            // Insert error before the form
            const form = document.querySelector('form');
            form.parentNode.insertBefore(errorDiv, form);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 8000);
        }

        // Funci√≥n para mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Funci√≥n para alternar visibilidad de contrase√±a
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.querySelector('.toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'üôà';
                toggleButton.setAttribute('aria-label', 'Ocultar contrase√±a');
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'üëÅÔ∏è';
                toggleButton.setAttribute('aria-label', 'Mostrar contrase√±a');
            }
        }

        // Mejora de accesibilidad: permitir Enter en los roles
        document.querySelectorAll('.role-card input[type="radio"]').forEach(radio => {
            radio.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    this.checked = true;
                }
            });
        });

        // Clear errors when user starts typing
        document.getElementById('usuario').addEventListener('input', clearErrors);
        document.getElementById('password').addEventListener('input', clearErrors);

        function clearErrors() {
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
        }
    </script>
</body>
</html>